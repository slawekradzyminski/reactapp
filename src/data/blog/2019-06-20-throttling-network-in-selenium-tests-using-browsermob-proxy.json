{
  "id": "2019-06-20-throttling-network-in-selenium-tests-using-browsermob-proxy",
  "title": "Throttling network in Selenium tests using BrowserMob Proxy",
  "date": "2019-06-20",
  "category": "Selenium",
  "permalink": "/2019/06/throttling-network-in-selenium-tests",
  "content": "<img src=\"/images/blog/photo-1520869562399-e772f042f422.jpeg\" alt=\"\">\n\n<p>It&#39;s a good testing practice to avoid as many external dependencies as possible. We want to run everything on localhost and avoid test failures caused by things outside our application scope (environment issues, network problems, unavailable web services).</p><p>Unfortunately, our clients don&#39;t access applications in a sterile environment. Many of them use rather slow GPRS/3G Internet connection with significant latency caused by cellular interface. Hence we need to check how our systems cope with slow Internet connection.</p><p>When it comes to manual verification the choice is straightforward. <a href=\"https://developers.google.com/web/tools/chrome-devtools/device-mode/?utm_source=dcc&utm_medium=redirect&utm_campaign=2016q3\" target=\"_blank\" rel=\"noreferrer\">Chrome Dev Tools</a> have powerful network throttling functionalities. Sometimes though, we want to create an automated functional test which checks that everything works fine with limited bandwidth. How to do it?</p><p>The easiest solution is to <a href=\"https://www.awesome-testing.com/2018/01/how-to-use-automated-functional-tests.html\" target=\"_blank\" rel=\"noreferrer\">set up a proxy</a> through which we would pass network traffic. BrowserMob Proxy is a great tool that integrates nicely with Selenium and has very easy to use Java API. BrowserMob Proxy allows you to manipulate HTTP requests and responses, capture HTTP content, and export performance data as a HAR file. I&#39;ve described the performance measuring feature in a <a href=\"https://www.awesome-testing.com/2016/10/browsermob-proxy-selenium-network.html\" target=\"_blank\" rel=\"noreferrer\">separate post</a>.</p><h2>Understanding network bandwidth and latency</h2>\n<p>Before I&#39;ll show you how to throttle network in traditional demo let&#39;s clarify what exactly network latency and bandwidth.</p><p>Latency is the amount of time it takes for data to travel from source to destination. It is dependent on the distance that data must travel through cords, networks, radio interfaces and the like to reach its destination. If you are an online gamer you probably check your ping. That&#39;s also your network latency.</p><p>Bandwidth is the rate of data transfer for a fixed period of time. The wider the communication band, the more data that can flow through it simultaneously. If you buy an Internet connection you most likely pay for maximum bandwidth (like 200 Mb/s).</p><h2>Demo</h2>\n<p>As usual, I have prepared a demo on my <a href=\"https://github.com/slawekradzyminski/AwesomeTesting\" target=\"_blank\" rel=\"noreferrer\">GitHub project</a>. I&#39;m going to use <a href=\"https://fluentlenium.com/\" target=\"_blank\" rel=\"noreferrer\">FluentLenium</a> Selenium extension.</p><p>At first, we would like to start a BrowserMob Proxy and change default configuration:</p><p>a) By settings 300ms network latency</p><p>b) By settings 1Mb/s (1 000 000 bytes/s) download and upload limit</p><p>c) By changing HTTP request user agent header to custom value (this simplifies debugging)</p><pre><code class=\"hljs language-java\">\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-variable\">BROWSER_MOB_PROXY_PORT</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-number\">9191</span>;\n    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">USER_AGENT</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-string\">&quot;User-Agent&quot;</span>;\n\n    <span class=\"hljs-keyword\">protected</span> <span class=\"hljs-type\">BrowserMobProxyServer</span> <span class=\"hljs-variable\">server</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">BrowserMobProxyServer</span>();\n\n    <span class=\"hljs-meta\">@Before</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">startBMP</span><span class=\"hljs-params\">()</span> {\n        server.start(BROWSER_MOB_PROXY_PORT);\n        server.setReadBandwidthLimit(<span class=\"hljs-number\">1000000</span>);\n        server.setWriteBandwidthLimit(<span class=\"hljs-number\">1000000</span>);\n        server.setLatency(<span class=\"hljs-number\">300</span>, TimeUnit.MILLISECONDS);\n\n        server.removeHeader(USER_AGENT);\n        server.addHeader(USER_AGENT, <span class=\"hljs-string\">&quot;Throttled Chrome Selenium Test&quot;</span>);\n    }\n</code></pre><p>Next, we need to create a Proxy object that will be used in tests. BrowserMob Proxy gives as a very useful static method createSeleniumProxy() which simplifies setup. Next lines setup proxy IPv4 localhost urls.</p><pre><code class=\"hljs language-java\">\n    <span class=\"hljs-keyword\">private</span> Proxy <span class=\"hljs-title function_\">getProxy</span><span class=\"hljs-params\">()</span> {\n        <span class=\"hljs-type\">Proxy</span> <span class=\"hljs-variable\">seleniumProxy</span> <span class=\"hljs-operator\">=</span> ClientUtil.createSeleniumProxy(server);\n        <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">hostIp</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-literal\">null</span>;\n        <span class=\"hljs-keyword\">try</span> {\n            hostIp = Inet4Address.getLocalHost().getHostAddress();\n        } <span class=\"hljs-keyword\">catch</span> (UnknownHostException e) {\n            e.printStackTrace();\n        }\n        <span class=\"hljs-type\">String</span> <span class=\"hljs-variable\">proxyUrl</span> <span class=\"hljs-operator\">=</span> String.format(<span class=\"hljs-string\">&quot;%s:%s&quot;</span>, hostIp, BROWSER_MOB_PROXY_PORT);\n        seleniumProxy.setHttpProxy(proxyUrl);\n        seleniumProxy.setSslProxy(proxyUrl);\n\n        <span class=\"hljs-keyword\">return</span> seleniumProxy;\n    }\nview raw\n</code></pre><p>Now we just need to modify Selenium Capabilities. Chrome example below.</p><pre><code class=\"hljs language-java\">\n    <span class=\"hljs-keyword\">public</span> WebDriver <span class=\"hljs-title function_\">newWebDriver</span><span class=\"hljs-params\">()</span> {\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">ChromeDriver</span>(getChromeOptions());\n    }\n\n    <span class=\"hljs-keyword\">private</span> ChromeOptions <span class=\"hljs-title function_\">getChromeOptions</span><span class=\"hljs-params\">()</span> {\n        <span class=\"hljs-type\">ChromeOptions</span> <span class=\"hljs-variable\">options</span> <span class=\"hljs-operator\">=</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">ChromeOptions</span>();\n        options.setProxy(getProxy());\n        <span class=\"hljs-keyword\">return</span> options;\n    }\n</code></pre><p>And here is final test that checks my blog with 1Mb/s network bandwidth.</p><pre><code class=\"hljs language-java\">\n<span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">SlowNetworkTest</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title class_\">ThrottledChrome</span> {\n\n    <span class=\"hljs-meta\">@Page</span>\n    <span class=\"hljs-keyword\">private</span> AwesomeTestingPage awesomeTestingPage;\n\n    <span class=\"hljs-meta\">@Test</span>\n    <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title function_\">shouldLoadBlogOnSlowNetwork</span><span class=\"hljs-params\">()</span> {\n        goTo(awesomeTestingPage).isAt();\n    }\n\n}\n</code></pre><p>Happy proxying :)</p>"
}