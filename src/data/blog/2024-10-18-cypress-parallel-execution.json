{
  "id": "2024-10-18-cypress-parallel-execution",
  "title": "Cypress Parallel Execution",
  "date": "2024-10-18",
  "categories": [
    "Cypress"
  ],
  "tags": [
    "Cypress"
  ],
  "permalink": "/2024/10/cypress-parallel-execution",
  "content": "<p><img src=\"/images/blog/cyvspw.png\" alt=\"\"></p><p>As shown in the graph above, Playwright has recently overtaken Cypress in popularity. One key reason for this shift is Playwright’s support for <a href=\"https://playwright.dev/docs/test-parallel\" target=\"_blank\" rel=\"noreferrer\">parallel test execution</a>. This feature, which allows multiple tests to run simultaneously rather than one after another, plays a crucial role in reducing overall test duration and improving the feedback loop. Faster feedback enables quicker iteration, which is ideal for maintaining an efficient development process. It’s also worth noting that Selenium, while not the most popular choice for modern web testing, fully supports parallel execution as well by various means (test runners and Selenium Grid).</p><p>In this article, we’ll dive into how parallel execution works in Cypress. Please note that this article was written in October 2024, and the landscape may shift in the coming months. <a href=\"https://npmtrends.com/cypress-vs-playwright\" target=\"_blank\" rel=\"noreferrer\">npmtrends data</a> may prompt Cypress to adjust their roadmap as the competition evolves.</p><h2>Cypress Cloud</h2>\n<p>The most straightforward option is Cypress Cloud, which extensively covers parallel execution in its <a href=\"https://docs.cypress.io/guides/cloud/smart-orchestration/parallelization\" target=\"_blank\" rel=\"noreferrer\">official documentation</a>. However, Cypress Cloud is a <a href=\"https://www.cypress.io/pricing\" target=\"_blank\" rel=\"noreferrer\">paid service</a> costing $67/month for 50 licenses and 120,000 test executions. It’s a feature-rich product that covers all CI/CD aspects necessary for comprehensive test reporting.</p><p>That said, there are two important considerations:</p><ul>\n<li>Parallel execution in Cypress requires multiple runners (unlike Playwright, where parallelization is built into the framework). If you opt for cloud-based CI runners, additional costs will apply.</li>\n</ul>\n<p><img src=\"/images/blog/parallelization-diagram.png\" alt=\"\"></p><ul>\n<li>By using Cypress Cloud, you consent to having your data transferred and stored on their servers, which can pose challenges for security-conscious organizations.</li>\n</ul>\n<h2>Sorry Cypress / currents.dev</h2>\n<p>Before the release of Cypress 13, <a href=\"https://sorry-cypress.dev/\" target=\"_blank\" rel=\"noreferrer\">Sorry Cypress</a> was a popular alternative. It offered cheaper test execution in the cloud and, perhaps more importantly, allowed organizations to host the dashboard on their own infrastructure at no cost. This gave companies full control over their test data and costs, while also encouraging test engineers to develop valuable DevOps, CI/CD, Docker, and cloud skills by managing the infrastructure themselves.</p><p>However, in November 2023, the owners of Cypress made the decision to block this service, sparking significant controversy within the community. The decision, and how it was implemented, led to widespread debate. You can read more about the issue on the well-known <a href=\"https://currents.dev/posts/v13-blocking\" target=\"_blank\" rel=\"noreferrer\">currents.dev blog</a>. This marked a major turning point for the Cypress community, with many users migrating to Playwright, either because they couldn’t afford Cypress Cloud or due to concerns about data privacy.</p><p>Given the current landscape, it’s unlikely that Sorry Cypress will return. The <a href=\"https://currents.dev/blog\" target=\"_blank\" rel=\"noreferrer\">currents.dev</a> blog now actively advocates for Cypress users to transition to Playwright, leaving a sense of &quot;burned ground&quot; in the Cypress community.</p><h2>Handcrafted spec split</h2>\n<p>With an understanding of how parallel execution works in Cypress Cloud, you can create a custom solution to split tests across multiple jobs. In the example below, we use a custom GitLab CI template to run Cypress tests in two separate jobs. A simple shell script splits the tests into two groups (files starting with <code>a-n</code> and <code>o-z</code>) and runs them in parallel by passing a custom list of specs to the <a href=\"https://docs.cypress.io/guides/guides/command-line\" target=\"_blank\" rel=\"noreferrer\">Cypress CLI</a>. You can adjust this setup further by splitting tests into more jobs, depending on the number of runners available in your CI environment.</p><pre><code class=\"hljs language-yaml\"><span class=\"hljs-string\">.frontend-ui-tests-template:</span>\n  <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">cypress/base:20.18.0</span>\n  <span class=\"hljs-attr\">stage:</span> <span class=\"hljs-string\">test</span>\n  <span class=\"hljs-attr\">script:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">install</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">run</span> <span class=\"hljs-string\">start</span> <span class=\"hljs-string\">&amp;</span> <span class=\"hljs-string\">./node_modules/.bin/wait-on</span> <span class=\"hljs-string\">http://localhost:8099</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">FILES=$(ls</span> <span class=\"hljs-string\">cypress/e2e/${TEST_PATTERN}*.cy.ts</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">tr</span> <span class=\"hljs-string\">&#x27;\\n&#x27;</span> <span class=\"hljs-string\">&#x27;,&#x27;</span><span class=\"hljs-string\">)</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">FILES=${FILES%,}</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">./node_modules/.bin/cypress</span> <span class=\"hljs-string\">run</span> <span class=\"hljs-string\">--browser</span> <span class=\"hljs-string\">chrome</span> <span class=\"hljs-string\">--headed</span> <span class=\"hljs-string\">--spec</span> <span class=\"hljs-string\">&quot;$FILES&quot;</span>\n  <span class=\"hljs-attr\">artifacts:</span>\n    <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">on_failure</span>\n    <span class=\"hljs-attr\">paths:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">frontend/cypress/screenshots/*</span>\n    <span class=\"hljs-attr\">expire_in:</span> <span class=\"hljs-number\">4</span> <span class=\"hljs-string\">hours</span>\n\n<span class=\"hljs-attr\">frontend UI tests part 1:</span>\n  <span class=\"hljs-attr\">extends:</span> <span class=\"hljs-string\">.frontend-ui-tests-template</span>\n  <span class=\"hljs-attr\">variables:</span>\n    <span class=\"hljs-attr\">TEST_PATTERN:</span> <span class=\"hljs-string\">&quot;[a-n]&quot;</span>\n\n<span class=\"hljs-attr\">frontend UI tests part 2:</span>\n  <span class=\"hljs-attr\">extends:</span> <span class=\"hljs-string\">.frontend-ui-tests-template</span>\n  <span class=\"hljs-attr\">variables:</span>\n    <span class=\"hljs-attr\">TEST_PATTERN:</span> <span class=\"hljs-string\">&quot;[o-z]&quot;</span></code></pre><p>The only downside of this approach is the lack of a consolidated test report. If a single report is necessary, consider using the <a href=\"https://www.browserstack.com/docs/test-management/upload-reports-cli/frameworks/cypress\" target=\"_blank\" rel=\"noreferrer\">junit reporter</a> along with <a href=\"https://www.npmjs.com/package/junit-report-merger\" target=\"_blank\" rel=\"noreferrer\">junit-report-merger</a> to generate a summary report.</p><p>The main advantage of this method is that it allows you to run tests in parallel without incurring additional costs. It’s unlikely that Cypress will remove the <code>--spec</code> flag from the CLI, as doing so would block single-test executions via the command line. The only tricky part is managing the reporting, but if you&#39;re focused on <a href=\"https://www.awesome-testing.com/2020/02/isolated-cypress-ui-tests\" target=\"_blank\" rel=\"noreferrer\">isolated tests</a> with mocked backends, this shouldn’t be a significant issue. In my workflow, where I write such tests, the results are fairly binary: if the tests pass, I merge the PR; if they fail, I investigate and fix the code or tests.</p><h2>cypress-split</h2>\n<p>In yet another chapter of the ongoing Cypress drama, the main figure is Gleb Bahmutov, a former core team member who spent four years working on the Cypress Test Runner. Now focusing on his <a href=\"https://cypress.tips/courses\" target=\"_blank\" rel=\"noreferrer\">Cypress courses</a> , Gleb has been openly critical of how the library is currently managed. His stance is best captured in his <a href=\"https://glebbahmutov.com/blog/cypress-parallel-free/\" target=\"_blank\" rel=\"noreferrer\">blog post</a>, where he expresses his frustration with the situation:</p><blockquote class=\"blog-quote\"><p>You deserve your Cypress tests to run very quickly FOR FREE.</p><p></p></blockquote><p>Fortunately for us, Gleb has created a <a href=\"https://www.npmjs.com/package/cypress-split\" target=\"_blank\" rel=\"noreferrer\">cypress-split</a> plugin, which allows you to split tests into smaller chunks and run them in parallel. The plugin offers similar functionality to the handcrafted spec-splitting example mentioned earlier but is more sophisticated and user-friendly. Here’s how you can configure it in a GitLab CI pipeline:</p><pre><code class=\"hljs language-yaml\">  <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">cypress/base:20.18.0</span>\n  <span class=\"hljs-attr\">stage:</span> <span class=\"hljs-string\">test</span>\n  <span class=\"hljs-attr\">parallel:</span> <span class=\"hljs-number\">3</span>\n  <span class=\"hljs-attr\">script:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">install</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">run</span> <span class=\"hljs-string\">start</span> <span class=\"hljs-string\">&amp;</span> <span class=\"hljs-string\">./node_modules/.bin/wait-on</span> <span class=\"hljs-string\">http://localhost:8099</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">npx</span> <span class=\"hljs-string\">cypress</span> <span class=\"hljs-string\">run</span> <span class=\"hljs-string\">--browser</span> <span class=\"hljs-string\">chrome</span> <span class=\"hljs-string\">--headed</span> <span class=\"hljs-string\">--env</span> <span class=\"hljs-string\">split=true</span>\n  <span class=\"hljs-attr\">artifacts:</span>\n    <span class=\"hljs-attr\">when:</span> <span class=\"hljs-string\">on_failure</span>\n    <span class=\"hljs-attr\">paths:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">frontend/cypress/screenshots/*</span>\n    <span class=\"hljs-attr\">expire_in:</span> <span class=\"hljs-number\">4</span> <span class=\"hljs-string\">hours</span></code></pre><p>The number of code modification is minimal. You just need to install it via <code>npm i -D cypress-split</code> and modify <code>cypress.config.ts</code> to enable the plugin:</p><pre><code class=\"hljs language-typescript\"><span class=\"hljs-keyword\">const</span> cypressSplit = <span class=\"hljs-built_in\">require</span>(<span class=\"hljs-string\">&#x27;cypress-split&#x27;</span>)\n\n<span class=\"hljs-variable language_\">module</span>.<span class=\"hljs-property\">exports</span> = <span class=\"hljs-title function_\">defineConfig</span>({\n  <span class=\"hljs-attr\">e2e</span>: {\n    <span class=\"hljs-title function_\">setupNodeEvents</span>(<span class=\"hljs-params\">on, config</span>) {\n      <span class=\"hljs-title function_\">cypressSplit</span>(on, config)\n      <span class=\"hljs-keyword\">return</span> config\n    },\n  },\n})</code></pre><p>There are two potential downsides to this approach:</p><ul>\n<li><p>Cypress owners may block this plugin in future releases, as they’ve done with other plugins before. If that happens, you’ll have to revert to a custom spec-splitting solution. </p></li>\n<li><p>similar to handcrafted spec split, you need to have a way to merge the test results into a single report.</p></li>\n</ul>\n<p>Considering <code>cypress-split</code> is developed by ex-Cypress core team member, I recommend you to ignore other plugins (like <a href=\"https://www.npmjs.com/package/cypress-parallel\" target=\"_blank\" rel=\"noreferrer\">cypress-parallel</a>) and stick with it. I recently migrated my Cypress tests to use cypress-split, and it has been working flawlessly so far. As of October 2024, this is my recommended approach!</p>"
}